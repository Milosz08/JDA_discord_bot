/*
 * Copyright (c) 2024 by JWizard
 * Originally developed by Mi≈Çosz Gilga <https://miloszgilga.pl>
 */
import java.time.LocalDateTime

plugins {
  alias libs.plugins.kotlinJvm
  alias libs.plugins.kotlinSerialization
  alias libs.plugins.kotlinSpring apply false
}

static def getEnv(String name, Object defValue = '') {
  return System.getenv("JWIZARD_CORE_$name") ?: defValue.toString()
}

static def getPluginId(Provider<PluginDependency> accessor) {
  return accessor.get().pluginId
}

configurations.configureEach {
  exclude group: 'commons-logging', module: 'commons-logging'
}

allprojects {
  repositories {
    mavenCentral()
    maven { url = uri('https://m2.dv8tion.net/releases') }
    maven { url = uri('https://m2.chew.pro/releases') }
    maven { url = uri('https://m2.chew.pro/snapshots') }
    maven { url = uri('https://maven.lavalink.dev/snapshots') }
    maven { url = uri('https://maven.lavalink.dev/releases') }
    maven { url = uri('https://jitpack.io') }
    mavenLocal()
  }
  group = groupId
  version = version
}

subprojects {
  apply plugin: getPluginId(libs.plugins.kotlinJvm)
  apply plugin: getPluginId(libs.plugins.kotlinSpring)

  if (project.name != initProjectName) {
    apply plugin: 'java-library'
  }

  java.sourceCompatibility = jvmVersion
  java.targetCompatibility = jvmVersion

  dependencies {
    implementation libs.kotlin
    implementation libs.kotlinReflect

    implementation libs.logbackCore
    implementation libs.logbackClassic
    implementation libs.slf4jApi
  }

  test {
    useJUnitPlatform()
  }

  tasks.compileKotlin {
    kotlinOptions {
      jvmTarget = jvmVersion.toString()
      freeCompilerArgs = [
        '-Xjsr305=strict'
      ]
    }
  }
}

project(":${initProjectName}") {
  apply plugin: getPluginId(libs.plugins.springBoot)

  tasks.bootJar {
    destinationDirectory = file("$rootDir/.bin")
    archiveFileName = 'jwizard-core.jar'
  }
}

tasks.clean {
  doLast {
    def binDir = file("$projectDir/.bin")
    if (binDir.exists()) {
      binDir.deleteDir()
    }
  }
}

tasks.register('bootJar') {
  dependsOn ":$initProjectName:bootJar"
}

tasks.register('createEnv') {
  def envFile = file("$projectDir/.bin/.env")
  if (envFile.exists()) {
    envFile.delete()
  }
  def currentDateTime = LocalDateTime.now()
  def values = [
    'VAULT_TOKEN'  : getEnv('VAULT_TOKEN'),
    'VAULT_SERVER' : getEnv('VAULT_SERVER'),
    'BUILD_VERSION': getEnv('BUILD_VERSION', 'DEVELOPMENT'),
    'BUILD_DATE'   : currentDateTime.toString(),
  ]
  def str = values
    .collect { key, value -> "JWIZARD_CORE_${key}=${value}" }
    .join('\n')
  envFile.write(str)
}
